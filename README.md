# Goowoo Pay Smart Contracts (Kaia)

[üá∫üá∏ English](#english) | [üá∞üá∑ ÌïúÍµ≠Ïñ¥](#ÌïúÍµ≠Ïñ¥)

---



# üá∫üá∏ English

Goowoo Pay smart contracts running on Kaia mainnet. Instant settlement (P2P) model where payments are directly transferred from buyer to seller/platform without custody.

### Table of Contents

- [Overview](#overview)
- [Store Creation](#store-creation)
- [Deployment Addresses](#deployment-addresses)
- [Architecture](#architecture)
- [Contract Descriptions](#contract-descriptions)
- [Installation/Environment Variables](#installationenvironment-variables)
- [Compile/Deploy/Verify](#compiledeployverify)
- [Testing](#testing)
- [Allowance Checklist](#allowance-checklist)
- [Usage Examples](#usage-examples)
- [API Reference](#api-reference)
- [Troubleshooting](#troubleshooting)
- [Tech Stack](#tech-stack)
- [Security/Operations](#securityoperations)

## Overview

- Token: Native USDT (Kaia)
- Store Creation: Individual stores created per seller via StoreFactory 
- Payment Flow: Buyer approves USDT to Router ‚Üí Router distributes to seller/platform ‚Üí Store records
- Refund Flow: Pull-refund from seller wallet (net) and platform wallet (fee) to buyer (full refund policy)
- Global/Store-specific pause: Router (global), Store (individual)
- Authority Management: Platform operator management through PlatformAuthority

## Store Creation

### 1. Creating Store via StoreFactory
```js
// Create new store through StoreFactory contract
const factory = await ethers.getContractAt("StoreFactory", factoryAddress);
const tx = await factory.createStore(sellerAddress, initialFeeBps);
const receipt = await tx.wait();

// Extract created store address
const storeAddress = receipt.events.find(e => e.event === "StoreCreated").args.store;
```

### 2. Store Configuration After Creation
```js
// Created store contract instance
const store = await ethers.getContractAt("Store", storeAddress);

// Check store information
const owner = await store.owner(); // Seller address
const feeBps = await store.feeBps(); // Fee rate (default: 100 = 1%)
const router = await store.router(); // PaymentRouter address
```

### 3. Store Management Features
- **Fee Change**: Only platform operators (`setFeeBps`)
- **Router Change**: Only platform operators (`setRouter`)
- **Pause**: Seller or platform operator (`pause`/`unpause`)

## Deployment Addresses

- PlatformAuthority: `0xe696Fcd2661C9C3Cf7898b7b5ABbA36f3ff1f10e`
- PaymentRouter: `0xa33acA5a4135a9eDfc39BC76c4E9d5DF78c47299`
- StoreFactory: `0x78351dEF0790cCAf430C02382625dE4F318d9170`

Explorer: [Kaiascan](https://kaiascan.io/)  ¬∑  RPC: `https://public-en.node.kaia.io`

## Architecture

```mermaid
graph TD
  A[Buyer] -- approve USDT --> R[PaymentRouter]
  A -- purchase(store, amount, purchaseId) --> R
  R -- net --> SOwner[Seller Wallet]
  R -- fee --> P[Platform Wallet]
  R -- recordPurchase --> ST[Store]

  SOwner -- refund trigger --> R
  R -- net from seller --> A
  R -- fee from platform --> A
  R -- recordRefund --> ST

  subgraph Registry
  F[StoreFactory] -- createStore --> ST
  end

  subgraph Authority
  PA[PlatformAuthority] -- operators --> ST
  PA -- operators --> R
  end
```

### Purchase Flow (Detailed)

```mermaid
sequenceDiagram
  participant Buyer
  participant Router
  participant Store as Store(seller-owned)
  participant Seller
  participant Platform
  Note over Buyer,Router: Buyer approves Router to spend USDT
  Buyer->>Router: purchase(store, amount, purchaseId)
  Router->>Seller: transferFrom(buyer, seller, net)
  Router->>Platform: transferFrom(buyer, platform, fee)
  Router->>Store: recordPurchase(purchaseId, buyer, amount, fee)
  Router-->>Buyer: Purchased event
```

### Refund Flow (Full Refund)

```mermaid
sequenceDiagram
  participant Seller
  participant Router
  participant Store
  participant Buyer
  participant Platform
  Seller->>Router: refund(store, purchaseId)
  Router->>Buyer: transferFrom(seller, buyer, net)
  Router->>Buyer: transferFrom(platform, buyer, fee)
  Router->>Store: recordRefund(purchaseId)
  Router-->>Seller: Refunded event
```

## Contract Descriptions

### PlatformAuthority.sol
- Owner registers/unregisters platform operators
- Functions: `addOperator(address)`, `removeOperator(address)`, `isOperator(address) -> bool`

### Store.sol (Owner=Seller)
- State: `platformAuthority`, `router`, `feeBps`, `PurchaseRecord`
- Only platform operators can `setFeeBps(uint16)`, `setRouter(address)`
- Records: `recordPurchase`, `recordRefund` (Router only)
- Pause: Seller or platform operator
- Queries: `getPurchase(purchaseId)`, `getPurchaseFields(..)`

### StoreFactory.sol
- Deploy stores with `createStore(seller, initialFeeBps)` (Router address injected at creation)
- Registry: `getStoresBySeller(seller)`, `isStore(store)`, `storeToSeller(store)`
- Management: `setRouter(address)`

### PaymentRouter.sol
- Immutable: `usdt`
- Configuration: `platformWallet`, `factory`
- Global pause: `pause()/unpause()` (platformWallet)
- Purchase: `purchase(store, amount, purchaseId)`
- Refund (full): `refund(store, purchaseId)` (seller only)
- Events: `Purchased`, `Refunded`, `PlatformWalletUpdated`, `FactoryUpdated`, `RouterPaused/Unpaused`

Fee calculation: `fee = amount * feeBps / 10_000`, `net = amount - fee`

## Installation/Environment Variables

### 1. Project Installation
```bash
npm install
```

### 2. Environment Variables Setup

#### Use Existing Example File
```bash
cp env.example .env
```

### 3. Edit Environment Variables

Open `.env` file and modify the following values:

#### üîê Required Settings
```env
# Deployment private key (with 0x prefix)
PRIVATE_KEY=

# Kaia mainnet USDT contract address
USDT_ADDRESS=0xd077a400968890eacc75cdc901f0356c943e4fdb

# Platform operation wallet address (receives fees)
PLATFORM_WALLET=
```

#### üìä Optional Settings
```env
# Kaiascan API key (for contract verification, optional)
KAIASCAN_API_KEY=

# Default fee rate (basis points, 100 = 1%)
DEFAULT_FEE_BPS=100

# Test seller wallet address (for sample store creation)
SELLER_ADDRESS=
```

### 4. Environment Variables Description

| Variable | Description | Required | Default |
|----------|-------------|----------|---------|
| `PRIVATE_KEY` | Deployment private key | ‚úÖ | - |
| `USDT_ADDRESS` | Kaia USDT contract address | ‚úÖ | `0xd077a400968890eacc75cdc901f0356c943e4fdb` |
| `PLATFORM_WALLET` | Platform operation wallet | ‚úÖ | - |
| `KAIASCAN_API_KEY` | Kaiascan API key | ‚ùå | - |
| `DEFAULT_FEE_BPS` | Default fee rate | ‚ùå | `100` (1%) |
| `SELLER_ADDRESS` | Test seller address | ‚ùå | - |

### 5. Network Configuration

Hardhat mainnet RPC uses `https://public-en.node.kaia.io`.

### ‚ö†Ô∏è Security Notes

- **Never commit `.env` file to GitHub!**
- Keep private keys in a secure location
- Use multisig wallets for production environments

## Compile/Deploy/Verify

### Compile
```bash
npm run compile
```

### Automated Deployment Script

The project includes a fully automated deployment script:

#### Local Network Deployment
```bash
npm run deploy:local
```

#### Testnet Deployment
```bash
npm run deploy:testnet
```

#### Mainnet Deployment
```bash
npm run deploy:mainnet
```

### Automated Deployment Script Features

`scripts/deploy.js` automatically performs the following tasks:

1. **PlatformAuthority Deployment** - Platform operator management
2. **PaymentRouter Deployment** - Payment router (USDT, platform wallet configuration)
3. **StoreFactory Deployment** - Store creation factory
4. **Initial Setup**:
   - Grant platform operator permissions
   - Connect Factory-Router
5. **Sample Store Creation** - Automatic test store creation
6. **Deployment Information Output** - All contract addresses and configuration info
7. **Verification Commands** - Auto-generated commands for Kaiascan verification

### Post-Deployment Checklist

After deployment completion, verify the following:

1. **Connect Router-Factory from Platform Wallet** (if needed):
```js
await router.setFactory(factoryAddress);
```

2. **Verify Contracts on Kaiascan**:
```bash
# Execute verification commands provided by deployment script
npx hardhat verify --network mainnet [contractAddress] [constructorParameters]
```

## Testing

### Running Tests
```bash
# Run all tests
npm test

# Run specific test file
npx hardhat test test/PaymentRouter.store.test.js

# Run tests with gas reporting
REPORT_GAS=true npm test
```

### Test Coverage
```bash
# Check test coverage (install required: npm install --save-dev solidity-coverage)
npx hardhat coverage
```

### Test Scenarios
Current tests include the following scenarios:

1. **Purchase Flow Tests**
   - Normal purchase processing
   - Fee calculation verification
   - Purchase record storage confirmation

2. **Refund Flow Tests**
   - Full refund processing
   - Refund record updates
   - Duplicate refund prevention

3. **Permission Management Tests**
   - Platform operator permission verification
   - Seller permission verification

4. **Pause Functionality Tests**
   - Global pause
   - Individual store pause

## Allowance Checklist

- Purchase: `buyer ‚Üí Router` approve `amount`
- Full refund policy (Option A):
  - `seller ‚Üí Router`: approve `net`
  - `platformWallet ‚Üí Router`: approve `fee`

## Usage Examples

Purchase
```js
// purchaseId recommended to be generated off-chain with keccak256(store, seller, buyer, nonce) etc.
const router = await ethers.getContractAt("PaymentRouter", routerAddress);
await usdt.approve(routerAddress, amount);
await router.purchase(storeAddress, amount, purchaseId);
```

Refund (full)
```js
// called from seller wallet
await usdt.connect(seller).approve(routerAddress, net);
await usdt.connect(platform).approve(routerAddress, fee);
await router.connect(seller).refund(storeAddress, purchaseId);
```

Global pause
```js
// called from platformWallet
await router.pause();
await router.unpause();
```

## API Reference

### PaymentRouter Main Functions

#### Purchase Related
```solidity
function purchase(address store, uint256 amount, bytes32 purchaseId) external
```
- Process purchase (buyer only)
- `store`: Store address
- `amount`: Purchase amount (USDT)
- `purchaseId`: Unique purchase ID

#### Refund Related
```solidity
function refund(address store, bytes32 purchaseId) external
```
- Process refund (seller only)
- Full refund policy applied

#### Management Functions
```solidity
function setPlatformWallet(address wallet) external
function setFactory(address factoryAddress) external
function pause() external
function unpause() external
```

### Store Main Functions

#### Configuration Functions
```solidity
function setRouter(address newRouter) external
function setFeeBps(uint16 newFeeBps) external
```
- Platform operators only

#### Query Functions
```solidity
function getPurchase(bytes32 purchaseId) external view returns (PurchaseRecord memory)
function getPurchaseFields(bytes32 purchaseId) external view returns (...)
function feeBps() external view returns (uint16)
```

### StoreFactory Main Functions

```solidity
function createStore(address sellerOwner, uint16 initialFeeBps) external returns (address)
function getStoresBySeller(address sellerOwner) external view returns (address[] memory)
function isStore(address store) external view returns (bool)
```

### PlatformAuthority Main Functions

```solidity
function addOperator(address account) external
function removeOperator(address account) external
function isOperator(address account) external view returns (bool)
```

### Key Events

```solidity
// PaymentRouter
event Purchased(address indexed store, address indexed buyer, address indexed seller, ...)
event Refunded(address indexed store, address indexed buyer, address indexed seller, ...)

// Store
event PurchaseRecorded(bytes32 indexed purchaseId, address indexed buyer, ...)
event RefundRecorded(bytes32 indexed purchaseId, uint256 amount, ...)

// StoreFactory
event StoreCreated(address indexed seller, address indexed store, uint16 feeBps)
```

## Troubleshooting

### Common Issues

#### 1. "Insufficient allowance" Error
```bash
# Solution: Approve sufficient USDT to Router from buyer wallet
await usdt.approve(routerAddress, amount);
```

#### 2. "Only platform operator" Error
```bash
# Solution: Check operator permissions in PlatformAuthority
await authority.isOperator(yourAddress);
```

#### 3. "Store not registered" Error
```bash
# Solution: Verify store registration in StoreFactory
await factory.isStore(storeAddress);
```

#### 4. Gas Limit Exceeded Error
```bash
# Solution: Increase gas limit
await contract.function({ gasLimit: 500000 });
```

#### 5. Network Connection Error
```bash
# Solution: Verify RPC URL
# Kaia Mainnet: https://public-en.node.kaia.io
```

### Debugging Tips

1. **Check Event Logs**: All major operations emit events
2. **Verify State**: Query contract states to identify issues
3. **Check Permissions**: Verify caller has appropriate permissions
4. **Verify Allowances**: Check USDT allowance status

## Tech Stack

### Core Technologies
- **Solidity**: `^0.8.20`
- **OpenZeppelin Contracts**: `^5.0.0`
- **Hardhat**: `^2.19.0`

### Development Tools
- **Hardhat**: Development environment and deployment
- **Ethers.js**: Blockchain interaction
- **Chai**: Testing framework

### Network
- **Kaia Mainnet**: `Chain ID: 8217`
- **RPC**: `https://public-en.node.kaia.io`
- **Explorer**: `https://kaiascan.io`

### Security Features
- **ReentrancyGuard**: Reentrancy attack prevention
- **Pausable**: Emergency response capability
- **SafeERC20**: Safe ERC20 token transfers

## Security/Operations

1. Private keys/operational keys recommended to use multisig or HSM
2. Approval limits recommended to operate with minimum necessary (caution with unlimited approval)
3. Reentrancy protection, idempotency (purchaseId/refund flags) applied
4. Minimize impact with Router/Store pause during incidents

---

References
- Explorer: [Kaiascan](https://kaiascan.io/)
- Kaia RPC: `https://public-en.node.kaia.io`
- OpenZeppelin Contracts: https://docs.openzeppelin.com/

# üá∞üá∑ ÌïúÍµ≠Ïñ¥

Kaia Î©îÏù∏ÎÑ∑ÏóêÏÑú ÎèôÏûëÌïòÎäî Goowoo Pay Í≤∞Ï†ú Ïä§ÎßàÌä∏ Ïª®Ìä∏ÎûôÌä∏ÏûÖÎãàÎã§. Ï¶âÏãú Ï†ïÏÇ∞(P2P) Î™®Îç∏Î°ú, Íµ¨Îß§ Ïãú Íµ¨Îß§Ïûê‚ÜíÌåêÎß§Ïûê/ÌîåÎû´ÌèºÏúºÎ°ú ÏßÅÏ†ë Ï†ÑÏÜ°ÎêòÎ©∞ Ïª§Ïä§ÌÑ∞ÎîîÎ•º Î≥¥Ïú†ÌïòÏßÄ ÏïäÏäµÎãàÎã§.

## Î™©Ï∞®

- [Í∞úÏöî](#Í∞úÏöî)
- [Ïä§ÌÜ†Ïñ¥ ÏÉùÏÑ±](#Ïä§ÌÜ†Ïñ¥-ÏÉùÏÑ±)
- [Î∞∞Ìè¨ Ï£ºÏÜå](#Î∞∞Ìè¨-Ï£ºÏÜå)
- [ÏïÑÌÇ§ÌÖçÏ≤ò](#ÏïÑÌÇ§ÌÖçÏ≤ò)
- [Ïª®Ìä∏ÎûôÌä∏ ÏÑ§Î™Ö](#Ïª®Ìä∏ÎûôÌä∏-ÏÑ§Î™Ö)
- [ÏÑ§Ïπò/ÌôòÍ≤ΩÎ≥ÄÏàò](#ÏÑ§ÏπòÌôòÍ≤ΩÎ≥ÄÏàò)
- [Ïª¥ÌååÏùº/Î∞∞Ìè¨/Í≤ÄÏ¶ù](#Ïª¥ÌååÏùºÎ∞∞Ìè¨Í≤ÄÏ¶ù)
- [ÌÖåÏä§Ìä∏](#ÌÖåÏä§Ìä∏)
- [ÏäπÏù∏(allowance) Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏](#ÏäπÏù∏allowance-Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏)
- [ÏÇ¨Ïö© ÏòàÏãú](#ÏÇ¨Ïö©-ÏòàÏãú)
- [API Ï∞∏Ï°∞](#api-Ï∞∏Ï°∞)
- [Î¨∏Ï†ú Ìï¥Í≤∞](#Î¨∏Ï†ú-Ìï¥Í≤∞)
- [Í∏∞Ïà† Ïä§ÌÉù](#Í∏∞Ïà†-Ïä§ÌÉù)
- [Î≥¥Ïïà/Ïö¥ÏòÅ](#Î≥¥ÏïàÏö¥ÏòÅ)

## Í∞úÏöî

- ÌÜ†ÌÅ∞: ÎÑ§Ïù¥Ìã∞Î∏å USDT (Kaia)
- Ïä§ÌÜ†Ïñ¥ ÏÉùÏÑ±: StoreFactoryÎ•º ÌÜµÌï¥ ÌåêÎß§ÏûêÎ≥Ñ Í∞úÎ≥Ñ Ïä§ÌÜ†Ïñ¥ ÏÉùÏÑ±
- Í≤∞Ï†ú ÌùêÎ¶Ñ: Íµ¨Îß§ÏûêÎäî RouterÏóê USDT ÏäπÏù∏ ‚Üí RouterÍ∞Ä ÌåêÎß§Ïûê/ÌîåÎû´ÌèºÏúºÎ°ú Î∂ÑÎ∞∞ ‚Üí StoreÏóê Í∏∞Î°ù
- ÌôòÎ∂à ÌùêÎ¶Ñ: ÌåêÎß§Ïûê ÏßÄÍ∞ëÏóêÏÑú ÏàúÍ∏àÏï°(net), ÌîåÎû´Ìèº ÏßÄÍ∞ëÏóêÏÑú ÏàòÏàòÎ£å(fee)Î•º buyerÏóêÍ≤å pull-refund (Ï†ÑÏï° ÌôòÎ∂à Ï†ïÏ±Ö)
- Ï†ÑÏó≠/Ïä§ÌÜ†Ïñ¥Î≥Ñ ÏùºÏãúÏ†ïÏßÄ: Router(Ï†ÑÏó≠), Store(Í∞úÎ≥Ñ)
- Í∂åÌïú Í¥ÄÎ¶¨: PlatformAuthorityÎ•º ÌÜµÌïú ÌîåÎû´Ìèº Ïö¥ÏòÅÏûê Í¥ÄÎ¶¨

## Ïä§ÌÜ†Ïñ¥ ÏÉùÏÑ±

### 1. StoreFactoryÎ•º ÌÜµÌïú Ïä§ÌÜ†Ïñ¥ ÏÉùÏÑ±
```js
// StoreFactory Ïª®Ìä∏ÎûôÌä∏Î•º ÌÜµÌï¥ ÏÉàÎ°úÏö¥ Ïä§ÌÜ†Ïñ¥ ÏÉùÏÑ±
const factory = await ethers.getContractAt("StoreFactory", factoryAddress);
const tx = await factory.createStore(sellerAddress, initialFeeBps);
const receipt = await tx.wait();

// ÏÉùÏÑ±Îêú Ïä§ÌÜ†Ïñ¥ Ï£ºÏÜå Ï∂îÏ∂ú
const storeAddress = receipt.events.find(e => e.event === "StoreCreated").args.store;
```

### 2. Ïä§ÌÜ†Ïñ¥ ÏÉùÏÑ± ÌõÑ ÏÑ§Ï†ï
```js
// ÏÉùÏÑ±Îêú Ïä§ÌÜ†Ïñ¥ Ïª®Ìä∏ÎûôÌä∏ Ïù∏Ïä§ÌÑ¥Ïä§
const store = await ethers.getContractAt("Store", storeAddress);

// Ïä§ÌÜ†Ïñ¥ Ï†ïÎ≥¥ ÌôïÏù∏
const owner = await store.owner(); // ÌåêÎß§Ïûê Ï£ºÏÜå
const feeBps = await store.feeBps(); // ÏàòÏàòÎ£å ÎπÑÏú® (Í∏∞Î≥∏Í∞í: 100 = 1%)
const router = await store.router(); // PaymentRouter Ï£ºÏÜå
```

### 3. Ïä§ÌÜ†Ïñ¥ Í¥ÄÎ¶¨ Í∏∞Îä•
- **ÏàòÏàòÎ£å Î≥ÄÍ≤Ω**: ÌîåÎû´Ìèº Ïö¥ÏòÅÏûêÎßå Í∞ÄÎä• (`setFeeBps`)
- **Router Î≥ÄÍ≤Ω**: ÌîåÎû´Ìèº Ïö¥ÏòÅÏûêÎßå Í∞ÄÎä• (`setRouter`)
- **ÏùºÏãúÏ†ïÏßÄ**: ÌåêÎß§Ïûê ÎòêÎäî ÌîåÎû´Ìèº Ïö¥ÏòÅÏûê Í∞ÄÎä• (`pause`/`unpause`)

## Î∞∞Ìè¨ Ï£ºÏÜå (BETA)

- PlatformAuthority: `0xe696Fcd2661C9C3Cf7898b7b5ABbA36f3ff1f10e`
- PaymentRouter: `0xa33acA5a4135a9eDfc39BC76c4E9d5DF78c47299`
- StoreFactory: `0x78351dEF0790cCAf430C02382625dE4F318d9170`

ÌÉêÏÉâÍ∏∞: [Kaiascan](https://kaiascan.io/)  ¬∑  RPC: `https://public-en.node.kaia.io`

## ÏïÑÌÇ§ÌÖçÏ≤ò

```mermaid
graph TD
  A[Buyer] -- approve USDT --> R[PaymentRouter]
  A -- purchase(store, amount, purchaseId) --> R
  R -- net --> SOwner[Seller Wallet]
  R -- fee --> P[Platform Wallet]
  R -- recordPurchase --> ST[Store]

  SOwner -- refund trigger --> R
  R -- net from seller --> A
  R -- fee from platform --> A
  R -- recordRefund --> ST

  subgraph Registry
  F[StoreFactory] -- createStore --> ST
  end

  subgraph Authority
  PA[PlatformAuthority] -- operators --> ST
  PA -- operators --> R
  end
```

##Íµ¨Îß§ ÌîåÎ°úÏö∞(ÏÉÅÏÑ∏)

```mermaid
sequenceDiagram
  participant Buyer
  participant Router
  participant Store as Store(seller-owned)
  participant Seller
  participant Platform
  Note over Buyer,Router: Buyer approves Router to spend USDT
  Buyer->>Router: purchase(store, amount, purchaseId)
  Router->>Seller: transferFrom(buyer, seller, net)
  Router->>Platform: transferFrom(buyer, platform, fee)
  Router->>Store: recordPurchase(purchaseId, buyer, amount, fee)
  Router-->>Buyer: Purchased event
```

### ÌôòÎ∂à ÌîåÎ°úÏö∞(Ï†ÑÏï° ÌôòÎ∂à)

```mermaid
sequenceDiagram
  participant Seller
  participant Router
  participant Store
  participant Buyer
  participant Platform
  Seller->>Router: refund(store, purchaseId)
  Router->>Buyer: transferFrom(seller, buyer, net)
  Router->>Buyer: transferFrom(platform, buyer, fee)
  Router->>Store: recordRefund(purchaseId)
  Router-->>Seller: Refunded event
```

## Ïª®Ìä∏ÎûôÌä∏ ÏÑ§Î™Ö

### PlatformAuthority.sol
- ÏÜåÏú†Ïûê(Owner)Í∞Ä ÌîåÎû´Ìèº Ïö¥ÏòÅÏûê(operator)Î•º Îì±Î°ù/Ìï¥Ï†ú
- Ìï®Ïàò: `addOperator(address)`, `removeOperator(address)`, `isOperator(address) -> bool`

### Store.sol (Ïò§ÎÑà=ÌåêÎß§Ïûê)
- ÏÉÅÌÉú: `platformAuthority`, `router`, `feeBps`, `PurchaseRecord`
- ÌîåÎû´Ìèº Ïö¥ÏòÅÏûêÎßå `setFeeBps(uint16)`, `setRouter(address)` Í∞ÄÎä•
- Í∏∞Î°ù: `recordPurchase`, `recordRefund` (RouterÎßå)
- ÏùºÏãúÏ†ïÏßÄ: ÌåêÎß§Ïûê ÎòêÎäî ÌîåÎû´Ìèº Ïö¥ÏòÅÏûê Í∞ÄÎä•
- Ï°∞Ìöå: `getPurchase(purchaseId)`, `getPurchaseFields(..)`

### StoreFactory.sol
- `createStore(seller, initialFeeBps)`Î°ú Ïä§ÌÜ†Ïñ¥ Î∞∞Ìè¨(ÏÉùÏÑ± Ïãú Router Ï£ºÏÜå Ï£ºÏûÖ)
- Î†àÏßÄÏä§Ìä∏Î¶¨: `getStoresBySeller(seller)`, `isStore(store)`, `storeToSeller(store)`
- Í¥ÄÎ¶¨: `setRouter(address)`

### PaymentRouter.sol
- Î∂àÎ≥Ä: `usdt`
- ÏÑ§Ï†ï: `platformWallet`, `factory`
- Ï†ÑÏó≠ ÏùºÏãúÏ†ïÏßÄ: `pause()/unpause()` (platformWallet)
- Íµ¨Îß§: `purchase(store, amount, purchaseId)`
- ÌôòÎ∂à(Ï†ÑÏï°): `refund(store, purchaseId)` (ÌåêÎß§ÏûêÎßå)
- Ïù¥Î≤§Ìä∏: `Purchased`, `Refunded`, `PlatformWalletUpdated`, `FactoryUpdated`, `RouterPaused/Unpaused`

ÏàòÏàòÎ£å Í≥ÑÏÇ∞: `fee = amount * feeBps / 10_000`, `net = amount - fee`

## ÏÑ§Ïπò/ÌôòÍ≤ΩÎ≥ÄÏàò

### 1. ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Ïπò
```bash
npm install
```

### 2. ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï

#### Í∏∞Ï°¥ ÏòàÏ†ú ÌååÏùº ÏÇ¨Ïö©
```bash
cp env.example .env
```

### 3. ÌôòÍ≤ΩÎ≥ÄÏàò Ìé∏Ïßë

`.env` ÌååÏùºÏùÑ Ïó¥Ïñ¥ÏÑú Îã§Ïùå Í∞íÎì§ÏùÑ ÏàòÏ†ïÌïòÏÑ∏Ïöî:

#### üîê ÌïÑÏàò ÏÑ§Ï†ï
```env
# Î∞∞Ìè¨Ïö© Í∞úÏù∏ÌÇ§ (0x Ï†ëÎëêÏÇ¨ Ìè¨Ìï®)
PRIVATE_KEY=

# Kaia Î©îÏù∏ÎÑ∑ USDT Ïª®Ìä∏ÎûôÌä∏ Ï£ºÏÜå
USDT_ADDRESS=0xd077a400968890eacc75cdc901f0356c943e4fdb

# ÌîåÎû´Ìèº Ïö¥ÏòÅ ÏßÄÍ∞ë Ï£ºÏÜå (ÏàòÏàòÎ£åÎ•º Î∞õÏùÑ ÏßÄÍ∞ë)
PLATFORM_WALLET=
```

#### üìä ÏÑ†ÌÉù ÏÑ§Ï†ï
```env
# Kaiascan API ÌÇ§ (Ïª®Ìä∏ÎûôÌä∏ Í≤ÄÏ¶ùÏö©, ÏÑ†ÌÉùÏÇ¨Ìï≠)
KAIASCAN_API_KEY=your_kaiascan_api_key_here

# Í∏∞Î≥∏ ÏàòÏàòÎ£å ÎπÑÏú® (basis points, 100 = 1%)
DEFAULT_FEE_BPS=100

# ÌÖåÏä§Ìä∏Ïö© ÌåêÎß§Ïûê ÏßÄÍ∞ë Ï£ºÏÜå (ÏÉòÌîå Ïä§ÌÜ†Ïñ¥ ÏÉùÏÑ±Ïö©)
SELLER_ADDRESS=
```

### 4. ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Î™Ö

| Î≥ÄÏàòÎ™Ö | ÏÑ§Î™Ö | ÌïÑÏàò | Í∏∞Î≥∏Í∞í |
|--------|------|------|--------|
| `PRIVATE_KEY` | Î∞∞Ìè¨Ïö© Í∞úÏù∏ÌÇ§ | ‚úÖ | - |
| `USDT_ADDRESS` | Kaia USDT Ïª®Ìä∏ÎûôÌä∏ Ï£ºÏÜå | ‚úÖ | `0xd077a400968890eacc75cdc901f0356c943e4fdb` |
| `PLATFORM_WALLET` | ÌîåÎû´Ìèº Ïö¥ÏòÅ ÏßÄÍ∞ë | ‚úÖ | - |
| `KAIASCAN_API_KEY` | Kaiascan API ÌÇ§ | ‚ùå | - |
| `DEFAULT_FEE_BPS` | Í∏∞Î≥∏ ÏàòÏàòÎ£å ÎπÑÏú® | ‚ùå | `100` (1%) |
| `SELLER_ADDRESS` | ÌÖåÏä§Ìä∏Ïö© ÌåêÎß§Ïûê Ï£ºÏÜå | ‚ùå | - |

### 5. ÎÑ§Ìä∏ÏõåÌÅ¨ ÏÑ§Ï†ï

Hardhat Î©îÏù∏ÎÑ∑ RPCÎäî `https://public-en.node.kaia.io` ÏÇ¨Ïö©.

### ‚ö†Ô∏è Î≥¥Ïïà Ï£ºÏùòÏÇ¨Ìï≠

- **Ï†àÎåÄ `.env` ÌååÏùºÏùÑ GitHubÏóê Ïª§Î∞ãÌïòÏßÄ ÎßàÏÑ∏Ïöî!**
- Í∞úÏù∏ÌÇ§Îäî ÏïàÏ†ÑÌïú Í≥≥Ïóê Î≥¥Í¥ÄÌïòÏÑ∏Ïöî
- ÌîÑÎ°úÎçïÏÖò ÌôòÍ≤ΩÏóêÏÑúÎäî Î©ÄÌã∞ÏãúÍ∑∏ ÏßÄÍ∞ë ÏÇ¨Ïö©ÏùÑ Í∂åÏû•Ìï©ÎãàÎã§

## Ïª¥ÌååÏùº/Î∞∞Ìè¨/Í≤ÄÏ¶ù

### Ïª¥ÌååÏùº
```bash
npm run compile
```

### ÏûêÎèô Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏

ÌîÑÎ°úÏ†ùÌä∏ÏóêÎäî ÏôÑÏ†Ñ ÏûêÎèôÌôîÎêú Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏Í∞Ä Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏäµÎãàÎã§:

#### Î°úÏª¨ ÎÑ§Ìä∏ÏõåÌÅ¨ Î∞∞Ìè¨
```bash
npm run deploy:local
```

#### ÌÖåÏä§Ìä∏ÎÑ∑ Î∞∞Ìè¨
```bash
npm run deploy:testnet
```

#### Î©îÏù∏ÎÑ∑ Î∞∞Ìè¨
```bash
npm run deploy:mainnet
```

### ÏûêÎèô Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ Í∏∞Îä•

`scripts/deploy.js`Îäî Îã§Ïùå ÏûëÏóÖÏùÑ ÏûêÎèôÏúºÎ°ú ÏàòÌñâÌï©ÎãàÎã§:

1. **PlatformAuthority Î∞∞Ìè¨** - ÌîåÎû´Ìèº Ïö¥ÏòÅÏûê Í¥ÄÎ¶¨
2. **PaymentRouter Î∞∞Ìè¨** - Í≤∞Ï†ú ÎùºÏö∞ÌÑ∞ (USDT, ÌîåÎû´Ìèº ÏßÄÍ∞ë ÏÑ§Ï†ï)
3. **StoreFactory Î∞∞Ìè¨** - Ïä§ÌÜ†Ïñ¥ ÏÉùÏÑ± Ìå©ÌÜ†Î¶¨
4. **Ï¥àÍ∏∞ ÏÑ§Ï†ï**:
   - ÌîåÎû´Ìèº Ïö¥ÏòÅÏûê Í∂åÌïú Î∂ÄÏó¨
   - Factory-Router Ïó∞Í≤∞ ÏÑ§Ï†ï
5. **ÏÉòÌîå Ïä§ÌÜ†Ïñ¥ ÏÉùÏÑ±** - ÌÖåÏä§Ìä∏Ïö© Ïä§ÌÜ†Ïñ¥ ÏûêÎèô ÏÉùÏÑ±
6. **Î∞∞Ìè¨ Ï†ïÎ≥¥ Ï∂úÎ†•** - Î™®Îì† Ïª®Ìä∏ÎûôÌä∏ Ï£ºÏÜåÏôÄ ÏÑ§Ï†ï Ï†ïÎ≥¥
7. **Í≤ÄÏ¶ù Î™ÖÎ†πÏñ¥ Ï†úÍ≥µ** - Kaiascan Í≤ÄÏ¶ùÏùÑ ÏúÑÌïú Î™ÖÎ†πÏñ¥ ÏûêÎèô ÏÉùÏÑ±

### Î∞∞Ìè¨ ÌõÑ ÌôïÏù∏ÏÇ¨Ìï≠

Î∞∞Ìè¨ ÏôÑÎ£å ÌõÑ Îã§ÏùåÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî:

1. **ÌîåÎû´Ìèº ÏßÄÍ∞ëÏóêÏÑú Router-Factory Ïó∞Í≤∞** (ÌïÑÏöîÏãú):
```js
await router.setFactory(factoryAddress);
```

2. **KaiascanÏóêÏÑú Ïª®Ìä∏ÎûôÌä∏ Í≤ÄÏ¶ù**:
```bash
# Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏Í∞Ä Ï†úÍ≥µÌïòÎäî Í≤ÄÏ¶ù Î™ÖÎ†πÏñ¥ Ïã§Ìñâ
npx hardhat verify --network mainnet [Ïª®Ìä∏ÎûôÌä∏Ï£ºÏÜå] [ÏÉùÏÑ±ÏûêÌååÎùºÎØ∏ÌÑ∞Îì§]
```

## ÌÖåÏä§Ìä∏

### ÌÖåÏä§Ìä∏ Ïã§Ìñâ
```bash
# Î™®Îì† ÌÖåÏä§Ìä∏ Ïã§Ìñâ
npm test

# ÌäπÏ†ï ÌÖåÏä§Ìä∏ ÌååÏùº Ïã§Ìñâ
npx hardhat test test/PaymentRouter.store.test.js

# Í∞ÄÏä§ ÏÇ¨Ïö©ÎüâÍ≥º Ìï®Íªò ÌÖåÏä§Ìä∏ Ïã§Ìñâ
REPORT_GAS=true npm test
```

### ÌÖåÏä§Ìä∏ Ïª§Î≤ÑÎ¶¨ÏßÄ
```bash
# ÌÖåÏä§Ìä∏ Ïª§Î≤ÑÎ¶¨ÏßÄ ÌôïÏù∏ (ÏÑ§Ïπò ÌïÑÏöî: npm install --save-dev solidity-coverage)
npx hardhat coverage
```

### ÌÖåÏä§Ìä∏ ÏãúÎÇòÎ¶¨Ïò§
ÌòÑÏû¨ ÌÖåÏä§Ìä∏Îäî Îã§Ïùå ÏãúÎÇòÎ¶¨Ïò§Î•º Ìè¨Ìï®Ìï©ÎãàÎã§:

1. **Íµ¨Îß§ ÌîåÎ°úÏö∞ ÌÖåÏä§Ìä∏**
   - Ï†ïÏÉÅÏ†ÅÏù∏ Íµ¨Îß§ Ï≤òÎ¶¨
   - ÏàòÏàòÎ£å Í≥ÑÏÇ∞ Í≤ÄÏ¶ù
   - Íµ¨Îß§ Í∏∞Î°ù Ï†ÄÏû• ÌôïÏù∏

2. **ÌôòÎ∂à ÌîåÎ°úÏö∞ ÌÖåÏä§Ìä∏**
   - Ï†ÑÏï° ÌôòÎ∂à Ï≤òÎ¶¨
   - ÌôòÎ∂à Í∏∞Î°ù ÏóÖÎç∞Ïù¥Ìä∏
   - Ï§ëÎ≥µ ÌôòÎ∂à Î∞©ÏßÄ

3. **Í∂åÌïú Í¥ÄÎ¶¨ ÌÖåÏä§Ìä∏**
   - ÌîåÎû´Ìèº Ïö¥ÏòÅÏûê Í∂åÌïú Í≤ÄÏ¶ù
   - ÌåêÎß§Ïûê Í∂åÌïú Í≤ÄÏ¶ù

4. **ÏùºÏãúÏ†ïÏßÄ Í∏∞Îä• ÌÖåÏä§Ìä∏**
   - Ï†ÑÏó≠ ÏùºÏãúÏ†ïÏßÄ
   - Í∞úÎ≥Ñ Ïä§ÌÜ†Ïñ¥ ÏùºÏãúÏ†ïÏßÄ

## ÏäπÏù∏(allowance) Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏

- Íµ¨Îß§: `buyer ‚Üí Router`Ïóê `amount` ÏäπÏù∏
- Ï†ÑÏï° ÌôòÎ∂à Ï†ïÏ±Ö(AÏïà):
  - `seller ‚Üí Router`: `net` ÏäπÏù∏
  - `platformWallet ‚Üí Router`: `fee` ÏäπÏù∏

## ÏÇ¨Ïö© ÏòàÏãú

Íµ¨Îß§
```js
// purchaseIdÎäî Ïò§ÌîÑÏ≤¥Ïù∏ÏóêÏÑú keccak256(store, seller, buyer, nonce) Îì±ÏúºÎ°ú ÏÉùÏÑ± Í∂åÏû•
const router = await ethers.getContractAt("PaymentRouter", routerAddress);
await usdt.approve(routerAddress, amount);
await router.purchase(storeAddress, amount, purchaseId);
```

ÌôòÎ∂à(Ï†ÑÏï°)
```js
// seller ÏßÄÍ∞ëÏóêÏÑú Ìò∏Ï∂ú
await usdt.connect(seller).approve(routerAddress, net);
await usdt.connect(platform).approve(routerAddress, fee);
await router.connect(seller).refund(storeAddress, purchaseId);
```

Ï†ÑÏó≠ ÏùºÏãúÏ†ïÏßÄ
```js
// platformWalletÏóêÏÑú Ìò∏Ï∂ú
await router.pause();
await router.unpause();
```

## API Ï∞∏Ï°∞

### PaymentRouter Ï£ºÏöî Ìï®Ïàò

#### Íµ¨Îß§ Í¥ÄÎ†®
```solidity
function purchase(address store, uint256 amount, bytes32 purchaseId) external
```
- Íµ¨Îß§ Ï≤òÎ¶¨ (Íµ¨Îß§ÏûêÎßå Ìò∏Ï∂ú Í∞ÄÎä•)
- `store`: Ïä§ÌÜ†Ïñ¥ Ï£ºÏÜå
- `amount`: Íµ¨Îß§ Í∏àÏï° (USDT)
- `purchaseId`: Í≥†Ïú† Íµ¨Îß§ ID

#### ÌôòÎ∂à Í¥ÄÎ†®
```solidity
function refund(address store, bytes32 purchaseId) external
```
- ÌôòÎ∂à Ï≤òÎ¶¨ (ÌåêÎß§ÏûêÎßå Ìò∏Ï∂ú Í∞ÄÎä•)
- Ï†ÑÏï° ÌôòÎ∂à Ï†ïÏ±Ö Ï†ÅÏö©

#### Í¥ÄÎ¶¨ Ìï®Ïàò
```solidity
function setPlatformWallet(address wallet) external
function setFactory(address factoryAddress) external
function pause() external
function unpause() external
```

### Store Ï£ºÏöî Ìï®Ïàò

#### ÏÑ§Ï†ï Ìï®Ïàò
```solidity
function setRouter(address newRouter) external
function setFeeBps(uint16 newFeeBps) external
```
- ÌîåÎû´Ìèº Ïö¥ÏòÅÏûêÎßå Ìò∏Ï∂ú Í∞ÄÎä•

#### Ï°∞Ìöå Ìï®Ïàò
```solidity
function getPurchase(bytes32 purchaseId) external view returns (PurchaseRecord memory)
function getPurchaseFields(bytes32 purchaseId) external view returns (...)
function feeBps() external view returns (uint16)
```

### StoreFactory Ï£ºÏöî Ìï®Ïàò

```solidity
function createStore(address sellerOwner, uint16 initialFeeBps) external returns (address)
function getStoresBySeller(address sellerOwner) external view returns (address[] memory)
function isStore(address store) external view returns (bool)
```

### PlatformAuthority Ï£ºÏöî Ìï®Ïàò

```solidity
function addOperator(address account) external
function removeOperator(address account) external
function isOperator(address account) external view returns (bool)
```

### Ï£ºÏöî Ïù¥Î≤§Ìä∏

```solidity
// PaymentRouter
event Purchased(address indexed store, address indexed buyer, address indexed seller, ...)
event Refunded(address indexed store, address indexed buyer, address indexed seller, ...)

// Store
event PurchaseRecorded(bytes32 indexed purchaseId, address indexed buyer, ...)
event RefundRecorded(bytes32 indexed purchaseId, uint256 amount, ...)

// StoreFactory
event StoreCreated(address indexed seller, address indexed store, uint16 feeBps)
```

## Î¨∏Ï†ú Ìï¥Í≤∞

### ÏûêÏ£º Î∞úÏÉùÌïòÎäî Î¨∏Ï†úÎì§

#### 1. "Insufficient allowance" Ïò§Î•ò
```bash
# Ìï¥Í≤∞Î∞©Î≤ï: Íµ¨Îß§Ïûê ÏßÄÍ∞ëÏóêÏÑú RouterÏóê Ï∂©Î∂ÑÌïú USDT ÏäπÏù∏
await usdt.approve(routerAddress, amount);
```

#### 2. "Only platform operator" Ïò§Î•ò
```bash
# Ìï¥Í≤∞Î∞©Î≤ï: PlatformAuthorityÏóêÏÑú Ïö¥ÏòÅÏûê Í∂åÌïú ÌôïÏù∏
await authority.isOperator(yourAddress);
```

#### 3. "Store not registered" Ïò§Î•ò
```bash
# Ìï¥Í≤∞Î∞©Î≤ï: StoreFactoryÏóêÏÑú Ïä§ÌÜ†Ïñ¥ Îì±Î°ù ÌôïÏù∏
await factory.isStore(storeAddress);
```

#### 4. Í∞ÄÏä§ Î∂ÄÏ°± Ïò§Î•ò
```bash
# Ìï¥Í≤∞Î∞©Î≤ï: Í∞ÄÏä§ ÌïúÎèÑ Ï¶ùÍ∞Ä
await contract.function({ gasLimit: 500000 });
```

#### 5. ÎÑ§Ìä∏ÏõåÌÅ¨ Ïó∞Í≤∞ Ïò§Î•ò
```bash
# Ìï¥Í≤∞Î∞©Î≤ï: RPC URL ÌôïÏù∏
# Kaia Î©îÏù∏ÎÑ∑: https://public-en.node.kaia.io
```

### ÎîîÎ≤ÑÍπÖ ÌåÅ

1. **Ïù¥Î≤§Ìä∏ Î°úÍ∑∏ ÌôïÏù∏**: Î™®Îì† Ï£ºÏöî ÏûëÏóÖÏùÄ Ïù¥Î≤§Ìä∏Î•º Î∞úÏÉùÏãúÌÇµÎãàÎã§
2. **ÏÉÅÌÉú ÌôïÏù∏**: Í∞Å Ïª®Ìä∏ÎûôÌä∏Ïùò ÏÉÅÌÉúÎ•º Ï°∞ÌöåÌïòÏó¨ Î¨∏Ï†ú ÌååÏïÖ
3. **Í∂åÌïú ÌôïÏù∏**: Ìò∏Ï∂úÏûêÍ∞Ä Ï†ÅÏ†àÌïú Í∂åÌïúÏùÑ Í∞ÄÏßÄÍ≥† ÏûàÎäîÏßÄ ÌôïÏù∏
4. **ÏäπÏù∏ ÌôïÏù∏**: USDT ÏäπÏù∏ ÏÉÅÌÉúÎ•º ÌôïÏù∏

## Í∏∞Ïà† Ïä§ÌÉù

### ÌïµÏã¨ Í∏∞Ïà†
- **Solidity**: `^0.8.20`
- **OpenZeppelin Contracts**: `^5.0.0`
- **Hardhat**: `^2.19.0`

### Í∞úÎ∞ú ÎèÑÍµ¨
- **Hardhat**: Í∞úÎ∞ú ÌôòÍ≤Ω Î∞è Î∞∞Ìè¨
- **Ethers.js**: Î∏îÎ°ùÏ≤¥Ïù∏ ÏÉÅÌò∏ÏûëÏö©
- **Chai**: ÌÖåÏä§Ìä∏ ÌîÑÎ†àÏûÑÏõåÌÅ¨

### ÎÑ§Ìä∏ÏõåÌÅ¨
- **Kaia Mainnet**: `Chain ID: 8217`
- **RPC**: `https://public-en.node.kaia.io`
- **Explorer**: `https://kaiascan.io`

### Î≥¥Ïïà Í∏∞Îä•
- **ReentrancyGuard**: Ïû¨ÏßÑÏûÖ Í≥µÍ≤© Î∞©ÏßÄ
- **Pausable**: Í∏¥Í∏â ÏÉÅÌô© ÎåÄÏùë
- **SafeERC20**: ÏïàÏ†ÑÌïú ERC20 ÌÜ†ÌÅ∞ Ï†ÑÏÜ°

## Î≥¥Ïïà/Ïö¥ÏòÅ

1. Í∞úÏù∏ÌÇ§/Ïö¥ÏòÅ ÌÇ§Îäî Î©ÄÌã∞ÏãúÍ∑∏ ÎòêÎäî HSM ÏÇ¨Ïö© Í∂åÏû•
2. ÏäπÏù∏ ÌïúÎèÑÎäî ÌïÑÏöî ÏµúÏÜåÌïúÏúºÎ°ú Ïö¥ÏòÅ Í∂åÏû•(Î¨¥Ï†úÌïú ÏäπÏù∏ Ïãú Ï£ºÏùò)
3. Ïû¨ÏßÑÏûÖ Î∞©ÏßÄ, idempotency(purchaseId/refund flags) Ï†ÅÏö©
4. Ïû•Ïï† Ïãú Router/StoreÏùò ÏùºÏãúÏ†ïÏßÄÎ°ú ÏòÅÌñ• ÏµúÏÜåÌôî

---

Ï∞∏Í≥†
- Explorer: [Kaiascan](https://kaiascan.io/)
- Kaia RPC: `https://public-en.node.kaia.io`
- OpenZeppelin Contracts: https://docs.openzeppelin.com/

---
